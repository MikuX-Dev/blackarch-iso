container:
  image: mikuxdev/archiso-builder:latest
  cpu: 6
  memory: 16G

task:
  name: Build and Push Arch ISO Docker Image
  only_if: $CIRRUS_BRANCH == 'master' || $CIRRUS_PR != ''
  env:
    GITHUB_TOKEN: ENCRYPTED[!1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef!]
  checkout_script:
    - git clone https://github.com/MikuX-Dev/blackarch-iso
    - mkdir -p work out
  install_script:
    - pacman -Syy
  build_script:
    - mkarchiso -v -r -w work -o out blackarch-iso/slim-iso
  upload_artifacts_script:
    - curl --request POST --header "Authorization: token $GITHUB_TOKEN" --header "Content-Type: application/zip" --data-binary "@out/*.iso" https://uploads.github.com/repos/$CIRRUS_REPO_FULL_NAME/releases/$RELEASE_ID/assets?name=Blackarch-slim-iso.iso
